# Development-optimized Dockerfile for faster builds
# Use with: docker build -f Dockerfile.dev -t djotter-dev .
FROM node:20-alpine

WORKDIR /app

# Install all dependencies with better caching
COPY package*.json ./
RUN --mount=type=cache,target=/root/.npm \
    npm ci --prefer-offline --no-audit --no-fund

COPY client/package*.json ./client/
RUN --mount=type=cache,target=/root/.npm \
    cd client && npm ci --prefer-offline --no-audit --no-fund

# Copy application code
COPY server/ ./server/
COPY client/src ./client/src/
COPY client/public ./client/public/
COPY client/index.html ./client/
COPY client/vite.config.js ./client/

# Build client
RUN --mount=type=cache,target=/root/.npm \
    cd client && npm run build

# Create data directories
RUN mkdir -p /app/data /app/journal && \
    chown -R node:node /app/data /app/journal

EXPOSE 8000
ENV NODE_ENV=production
# SECURITY: Set ADMIN_PASSWORD and JWT_SECRET at runtime via docker-compose.yml or docker run -e
# DO NOT hardcode secrets in the image

USER node
CMD ["npm", "start"]
